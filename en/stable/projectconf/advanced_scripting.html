

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Advanced Scripting &mdash; PlatformIO v5.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="https://docs.platformio.org/projectconf/advanced_scripting.html" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Library Management" href="../librarymanager/index.html" />
    <link rel="prev" title="Environment variables" href="../envvars.html" />
 
<link rel="stylesheet" href="../_static/css/extra.css" type="text/css" />
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- <script src="http://dl.platformio.org/misc/abplus.js"></script> -->

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PlatformIO
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../what-is-platformio.html">What is PlatformIO?</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../integration/ide/pioide.html">PlatformIO IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/index.html">PlatformIO Core (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../home/index.html">PlatformIO Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials and Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Configuration</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">platformio.ini</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Scripting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#launch-types">Launch types</a></li>
<li class="toctree-l2"><a class="reference internal" href="#construction-environments">Construction Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#before-pre-and-after-post-actions">Before/Pre and After/Post actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-middlewares">Build Middlewares</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-targets">Custom Targets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-system-api">Build System API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#command-shortcut">Command shortcut</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dependent-target">Dependent target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-with-options">Target with options</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#other-use-cases">Other Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-options-in-platformio-ini">Custom options in <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#split-c-c-build-flags">Split C/C++ build flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extra-linker-flags-without-wl-prefix">Extra Linker Flags without <code class="docutils literal notranslate"><span class="pre">-Wl,</span></code> prefix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-upload-tool">Custom upload tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upload-to-cloud-ota">Upload to Cloud (OTA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-firmware-program-name">Custom firmware/program name</a></li>
<li class="toctree-l3"><a class="reference internal" href="#override-package-files">Override package files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#override-board-configuration">Override Board Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-debug-flags">Custom debug flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extra-python-packages">Extra Python packages</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Instruments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../librarymanager/index.html">Library Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frameworks/index.html">Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boards/index.html">Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/custom_platform_and_board.html">Custom Platform &amp; Board</a></li>
</ul>
<p class="caption"><span class="caption-text">Professional</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plus/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plus/unit-testing.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plus/pio-check.html">Static Code Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plus/pio-remote.html">Remote Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plus/pio-account.html">PlatformIO Account</a></li>
</ul>
<p class="caption"><span class="caption-text">Integration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../integration/ide/index.html">Cloud &amp; Desktop IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integration/ci/index.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integration/compile_commands.html">Compilation database <code class="docutils literal notranslate"><span class="pre">compile_commands.json</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../articles.html">Articles about us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/history.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/migration.html">Migrating from 4.x to 5.0</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PlatformIO</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Advanced Scripting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/platformio/platformio-docs/blob/develop/projectconf/advanced_scripting.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced-scripting">
<span id="projectconf-advanced-scripting"></span><h1><a class="toc-backref" href="#id1">Advanced Scripting</a><a class="headerlink" href="#advanced-scripting" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Advanced Scripting is recommended for Advanced Users and requires
knowledge of the Python language.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a class="reference internal" href="section_env_build.html#projectconf-dynamic-build-flags"><span class="std std-ref">Dynamic build flags</span></a> is a highly recommended
alternative to advanced scripting, where you can use any programming
language. Also, that option is useful if you need to apply changes
to the project before the building/uploading process, such as:</p>
<ul class="simple">
<li><p>Macro with the latest VCS revision/tag “on-the-fly”</p></li>
<li><p>Generate dynamic headers (<code class="docutils literal notranslate"><span class="pre">*.h</span></code>)</p></li>
<li><p>Process media content before generating SPIFFS image</p></li>
<li><p>Make some changes to source code or related libraries</p></li>
</ul>
</div>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#advanced-scripting" id="id1">Advanced Scripting</a></p>
<ul>
<li><p><a class="reference internal" href="#launch-types" id="id2">Launch types</a></p></li>
<li><p><a class="reference internal" href="#construction-environments" id="id3">Construction Environments</a></p></li>
<li><p><a class="reference internal" href="#before-pre-and-after-post-actions" id="id4">Before/Pre and After/Post actions</a></p></li>
<li><p><a class="reference internal" href="#build-middlewares" id="id5">Build Middlewares</a></p></li>
<li><p><a class="reference internal" href="#custom-targets" id="id6">Custom Targets</a></p>
<ul>
<li><p><a class="reference internal" href="#build-system-api" id="id7">Build System API</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id8">Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#command-shortcut" id="id9">Command shortcut</a></p></li>
<li><p><a class="reference internal" href="#dependent-target" id="id10">Dependent target</a></p></li>
<li><p><a class="reference internal" href="#target-with-options" id="id11">Target with options</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#other-use-cases" id="id12">Other Use Cases</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-options-in-platformio-ini" id="id13">Custom options in <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code></a></p></li>
<li><p><a class="reference internal" href="#split-c-c-build-flags" id="id14">Split C/C++ build flags</a></p></li>
<li><p><a class="reference internal" href="#extra-linker-flags-without-wl-prefix" id="id15">Extra Linker Flags without <code class="docutils literal notranslate"><span class="pre">-Wl,</span></code> prefix</a></p></li>
<li><p><a class="reference internal" href="#custom-upload-tool" id="id16">Custom upload tool</a></p></li>
<li><p><a class="reference internal" href="#upload-to-cloud-ota" id="id17">Upload to Cloud (OTA)</a></p></li>
<li><p><a class="reference internal" href="#custom-firmware-program-name" id="id18">Custom firmware/program name</a></p></li>
<li><p><a class="reference internal" href="#override-package-files" id="id19">Override package files</a></p></li>
<li><p><a class="reference internal" href="#override-board-configuration" id="id20">Override Board Configuration</a></p></li>
<li><p><a class="reference internal" href="#custom-debug-flags" id="id21">Custom debug flags</a></p></li>
<li><p><a class="reference internal" href="#extra-python-packages" id="id22">Extra Python packages</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>The PlatformIO Build System allows the user to extend the build process with
custom scripts using the Python interpreter and
the <a class="reference external" href="http://www.scons.org">SCons</a> construction tool.
Build flags, upload flags, targets, toolchains data and other information are
available for modification as <a class="reference external" href="http://www.scons.org/doc/production/HTML/scons-user.html#chap-environments">SCons Construction Environments</a>.
Custom scripts are included with <a class="reference internal" href="section_env_advanced.html#projectconf-extra-scripts"><span class="std std-ref">extra_scripts</span></a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You can not run or debug these scripts manually with a Python
interpreter. They will be loaded automatically when the
<a class="reference internal" href="../core/userguide/cmd_run.html#cmd-run"><span class="std std-ref">pio run</span></a> command processes the project environment.</p>
</div>
<div class="section" id="launch-types">
<h2><a class="toc-backref" href="#id2">Launch types</a><a class="headerlink" href="#launch-types" title="Permalink to this headline">¶</a></h2>
<p>There are two execution orders for extra scripts:</p>
<ol class="arabic simple">
<li><p><strong>PRE</strong> - executes before the main script of <a class="reference internal" href="../platforms/index.html#platforms"><span class="std std-ref">Development Platforms</span></a></p></li>
<li><p><strong>POST</strong> - executes after the main script of <a class="reference internal" href="../platforms/index.html#platforms"><span class="std std-ref">Development Platforms</span></a></p></li>
</ol>
<p>Multiple extra scripts are allowed. Please split them via  “, ”
(comma + space) in the same line or use multi-line values.</p>
<p>For example, in <a class="reference internal" href="index.html#projectconf"><span class="std std-ref">“platformio.ini” (Project Configuration File)</span></a>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:my_env_1]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="c1">; Defaults to POST script since no prefix is used</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">post_extra_script.py</span>

<span class="k">[env:my_env_2]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span>
  <span class="na">pre:pre_extra_script.py</span>
  <span class="na">post:post_extra_script1.py</span>
  <span class="na">post_extra_script2.py</span>
</pre></div>
</div>
<p>This option can also be set by the global environment variable <span class="target" id="index-0"></span><a class="reference internal" href="../envvars.html#envvar-PLATFORMIO_EXTRA_SCRIPTS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PLATFORMIO_EXTRA_SCRIPTS</span></code></a>.</p>
</div>
<div class="section" id="construction-environments">
<h2><a class="toc-backref" href="#id3">Construction Environments</a><a class="headerlink" href="#construction-environments" title="Permalink to this headline">¶</a></h2>
<p>The PlatformIO Build System uses two built-in construction environments
to process each project:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">env</span></code>, <code class="docutils literal notranslate"><span class="pre">Import(&quot;env&quot;)</span></code> - the global construction environment used
for the <a class="reference internal" href="../platforms/index.html#platforms"><span class="std std-ref">Development Platforms</span></a> and <a class="reference internal" href="../frameworks/index.html#frameworks"><span class="std std-ref">Frameworks</span></a> build scripts, upload tools,
<a class="reference internal" href="../librarymanager/ldf.html#ldf"><span class="std std-ref">Library Dependency Finder (LDF)</span></a>, and other internal operations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">projenv</span></code>, <code class="docutils literal notranslate"><span class="pre">Import(&quot;projenv&quot;)</span></code> - the isolated construction environment
used for processing the project source code in <a class="reference internal" href="section_platformio.html#projectconf-pio-src-dir"><span class="std std-ref">src_dir</span></a>.
Please note that any <a class="reference internal" href="section_env_build.html#projectconf-src-build-flags"><span class="std std-ref">src_build_flags</span></a> specified in
<a class="reference internal" href="index.html#projectconf"><span class="std std-ref">“platformio.ini” (Project Configuration File)</span></a> will be passed to <code class="docutils literal notranslate"><span class="pre">projenv</span></code> and not to <code class="docutils literal notranslate"><span class="pre">env</span></code>.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">projenv</span></code> is available only for POST-type scripts</p></li>
<li><p>Flags passed to <code class="docutils literal notranslate"><span class="pre">env</span></code> using PRE-type script will affect <code class="docutils literal notranslate"><span class="pre">projenv</span></code> too.</p></li>
</ol>
</div>
<p><code class="docutils literal notranslate"><span class="pre">my_pre_extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1"># access to global construction environment</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1"># Dump construction environment (for debug purpose)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">Dump</span><span class="p">())</span>

<span class="c1"># append extra flags to global build environment</span>
<span class="c1"># which later will be used to build:</span>
<span class="c1"># - project source code</span>
<span class="c1"># - frameworks</span>
<span class="c1"># - dependent libraries</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CPPDEFINES</span><span class="o">=</span><span class="p">[</span>
  <span class="s2">&quot;MACRO_1_NAME&quot;</span><span class="p">,</span>
  <span class="p">(</span><span class="s2">&quot;MACRO_2_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;MACRO_2_VALUE&quot;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">my_post_extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;projenv&quot;</span><span class="p">)</span>

<span class="c1"># access to global construction environment</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1"># access to project construction environment</span>
<span class="nb">print</span><span class="p">(</span><span class="n">projenv</span><span class="p">)</span>

<span class="c1"># Dump construction environments (for debug purpose)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">Dump</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">projenv</span><span class="o">.</span><span class="n">Dump</span><span class="p">())</span>

<span class="c1"># append extra flags to global build environment</span>
<span class="c1"># which later will be used to build:</span>
<span class="c1"># - frameworks</span>
<span class="c1"># - dependent libraries</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CPPDEFINES</span><span class="o">=</span><span class="p">[</span>
  <span class="s2">&quot;MACRO_1_NAME&quot;</span><span class="p">,</span>
  <span class="p">(</span><span class="s2">&quot;MACRO_2_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;MACRO_2_VALUE&quot;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># append extra flags to only project build environment</span>
<span class="n">projenv</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CPPDEFINES</span><span class="o">=</span><span class="p">[</span>
  <span class="s2">&quot;PROJECT_EXTRA_MACRO_1_NAME&quot;</span><span class="p">,</span>
  <span class="p">(</span><span class="s2">&quot;ROJECT_EXTRA_MACRO_2_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;ROJECT_EXTRA_MACRO_2_VALUE&quot;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>See examples below how to import construction environments and modify existing
data or add new.</p>
</div>
<div class="section" id="before-pre-and-after-post-actions">
<h2><a class="toc-backref" href="#id4">Before/Pre and After/Post actions</a><a class="headerlink" href="#before-pre-and-after-post-actions" title="Permalink to this headline">¶</a></h2>
<p>The PlatformIO Build System has a rich API that allows one to attach different pre-/post
actions (hooks) using <code class="docutils literal notranslate"><span class="pre">env.AddPreAction(target,</span> <span class="pre">callback)</span></code> or
<code class="docutils literal notranslate"><span class="pre">env.AddPreAction(target,</span> <span class="pre">[callback1,</span> <span class="pre">callback2,</span> <span class="pre">...])</span></code> function. The first
argument <code class="docutils literal notranslate"><span class="pre">target</span></code> can be the name of a target that is passed using the
<a class="reference internal" href="../core/userguide/cmd_run.html#cmdoption-pio-run-t"><code class="xref std std-option docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">--target</span></code></a> command, the name of a built-in target
(buildprog, size, upload, program, buildfs, uploadfs, uploadfsota) or the path
to a file which PlatformIO processes (ELF, HEX, BIN, OBJ, etc.).</p>
<p><strong>Examples</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> file is located in the same directory as <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:pre_and_post_hooks]</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">post:extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;projenv&quot;</span><span class="p">)</span>

<span class="c1"># access to global build environment</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1"># access to project build environment (is used source files in &quot;src&quot; folder)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">projenv</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Dump build environment (for debug purpose)</span>
<span class="c1"># print(env.Dump())</span>
<span class="c1">#</span>

<span class="c1">#</span>
<span class="c1"># Change build flags in runtime</span>
<span class="c1">#</span>
<span class="n">env</span><span class="o">.</span><span class="n">ProcessUnFlags</span><span class="p">(</span><span class="s2">&quot;-DVECT_TAB_ADDR&quot;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CPPDEFINES</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;VECT_TAB_ADDR&quot;</span><span class="p">,</span> <span class="mh">0x123456789</span><span class="p">))</span>

<span class="c1">#</span>
<span class="c1"># Upload actions</span>
<span class="c1">#</span>

<span class="k">def</span> <span class="nf">before_upload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before_upload&quot;</span><span class="p">)</span>
    <span class="c1"># do some actions</span>

    <span class="c1"># call Node.JS or other script</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;node --version&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">after_upload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after_upload&quot;</span><span class="p">)</span>
    <span class="c1"># do some actions</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current build targets&quot;</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">BUILD_TARGETS</span><span class="p">))</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddPreAction</span><span class="p">(</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="n">before_upload</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPostAction</span><span class="p">(</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="n">after_upload</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Custom actions when building program/firmware</span>
<span class="c1">#</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddPreAction</span><span class="p">(</span><span class="s2">&quot;buildprog&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">...</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPostAction</span><span class="p">(</span><span class="s2">&quot;buildprog&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">...</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Custom actions for specific files/objects</span>
<span class="c1">#</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddPreAction</span><span class="p">(</span><span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.elf&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">callback1</span><span class="p">,</span> <span class="n">callback2</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPostAction</span><span class="p">(</span><span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.hex&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># custom action before building SPIFFS image. For example, compress HTML, etc.</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPreAction</span><span class="p">(</span><span class="s2">&quot;$BUILD_DIR/spiffs.bin&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># custom action for project&#39;s main.cpp</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPostAction</span><span class="p">(</span><span class="s2">&quot;$BUILD_DIR/src/main.cpp.o&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># Custom HEX from ELF</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddPostAction</span><span class="p">(</span>
    <span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.elf&quot;</span><span class="p">,</span>
    <span class="n">env</span><span class="o">.</span><span class="n">VerboseAction</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="s2">&quot;$OBJCOPY&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="s2">&quot;ihex&quot;</span><span class="p">,</span> <span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="s2">&quot;.eeprom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.elf&quot;</span><span class="p">,</span> <span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.hex&quot;</span>
    <span class="p">]),</span> <span class="s2">&quot;Building $BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.hex&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="build-middlewares">
<h2><a class="toc-backref" href="#id5">Build Middlewares</a><a class="headerlink" href="#build-middlewares" title="Permalink to this headline">¶</a></h2>
<p>PlatformIO Build System allows you to add middleware functions that can be used for
Build Node(Object) construction. This is very useful if you need to add custom flags
for the specific file nodes or exclude them from a build process.</p>
<p>There is <code class="docutils literal notranslate"><span class="pre">env.AddBuildMiddleware(callback,</span> <span class="pre">pattern)</span></code> helper which instructs
PlatformIO Build System to call <code class="docutils literal notranslate"><span class="pre">callback</span></code> for each <a class="reference external" href="https://scons.org/doc/latest/HTML/scons-api/SCons.Node.FS.Dir-class.html">SCons File System Node</a>
whose path matches with <a class="reference external" href="https://docs.python.org/3.8/library/fnmatch.html">Unix shell-style “pattern” (wildcards)</a>.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">pattern</span></code> is omitted, the <code class="docutils literal notranslate"><span class="pre">callback</span></code> will be called for each File System Node
which is added for the build process.</p>
<p>You can add an unlimited number of build middlewares. They will be called in order of
registration. Please note, if the first middleware ignores some File Nodes, they will
not be passed to the next middleware in chain.</p>
<p><strong>Examples</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:build_middleware]</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">pre:extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>


<span class="c1"># --- Add custom macros for the ALL files which name contains &quot;http&quot;</span>
<span class="k">def</span> <span class="nf">extra_http_configuration</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `node.name` - a name of File System Node</span>
<span class="sd">    `node.get_path()` - a relative path</span>
<span class="sd">    `node.get_abspath()` - an absolute path</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># do not modify node if file name does not contain &quot;http&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;http&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="c1"># now, we can override ANY SCons variables (CPPDEFINES, CCFLAGS, etc.,) for the specific file</span>
    <span class="c1"># pass SCons variables as extra keyword arguments to `env.Object()` function</span>
    <span class="c1"># p.s: run `pio run -t envdump` to see a list with SCons variables</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span>
        <span class="n">node</span><span class="p">,</span>
        <span class="n">CPPDEFINES</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;CPPDEFINES&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;HTTP_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;device.local&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;HTTP_PORT&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)],</span>
        <span class="n">CCFLAGS</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;CCFLAGS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;-fno-builtin-printf&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddBuildMiddleware</span><span class="p">(</span><span class="n">extra_http_configuration</span><span class="p">)</span>


<span class="c1"># --- Replace some file from a build process with another</span>

<span class="k">def</span> <span class="nf">replace_node_with_another</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;path/to/patched/RtosTimer.cpp&quot;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddBuildMiddleware</span><span class="p">(</span>
    <span class="n">replace_node_with_another</span><span class="p">,</span>
    <span class="s2">&quot;framework-mbed/rtos/RtosTimer.cpp&quot;</span>
<span class="p">)</span>


<span class="c1"># --- Skip assembly *.S files from build process</span>

<span class="k">def</span> <span class="nf">skip_asm_from_build</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="c1"># to ignore file from a build process, just return None</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddBuildMiddleware</span><span class="p">(</span><span class="n">skip_asm_from_build</span><span class="p">,</span> <span class="s2">&quot;*.S&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-targets">
<span id="projectconf-advanced-scripting-custom-targets"></span><h2><a class="toc-backref" href="#id6">Custom Targets</a><a class="headerlink" href="#custom-targets" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 5.0.</span></p>
</div>
<p>PlatformIO allows you to declare unlimited number of the custom targets. There are a
lot of use cases for them:</p>
<ul class="simple">
<li><p>Pre/Post processing based on a dependent sources (other target, source file, etc.)</p></li>
<li><p>Command launcher with own arguments</p></li>
<li><p>Launch command with custom options declared in <a class="reference internal" href="index.html#projectconf"><span class="std std-ref">“platformio.ini” (Project Configuration File)</span></a></p></li>
<li><p>Python callback as a target (use the power of Python interpreter and PlatformIO Build API).</p></li>
</ul>
<p>A custom target can be processed using <a class="reference internal" href="../core/userguide/cmd_run.html#cmdoption-pio-run-t"><code class="xref std std-option docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">--target</span></code></a> option and
you can list them via <a class="reference internal" href="../core/userguide/cmd_run.html#cmdoption-pio-run-list-targets"><code class="xref std std-option docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">--list-targets</span></code></a> command.</p>
<div class="section" id="build-system-api">
<h3><a class="toc-backref" href="#id7">Build System API</a><a class="headerlink" href="#build-system-api" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddCustomTarget</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="p">,</span>
    <span class="n">actions</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">always_build</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">AddCustomTarget</span></code> arguments:</p>
<dl class="field-list simple">
<dt class="field-odd">name</dt>
<dd class="field-odd"><p>A name of target. ASCII chars (a-z, 0-9, _, -) are recommended. Good names are
“gen_headers”, “program_bitstream”, etc.</p>
</dd>
<dt class="field-even">dependencies</dt>
<dd class="field-even"><p>A list of dependencies that should be built BEFORE target will be launched. It is
possible pass multiple dependencies as a Python list <code class="docutils literal notranslate"><span class="pre">[&quot;dep1&quot;,</span> <span class="pre">dep_target_2]</span></code>.
If a target does not have dependencies, <code class="docutils literal notranslate"><span class="pre">None</span></code> should be passed.</p>
</dd>
<dt class="field-odd">actions</dt>
<dd class="field-odd"><p>A list of actions to call on a target. It is possible to pass multiple actions as
a Python list <code class="docutils literal notranslate"><span class="pre">[&quot;python</span> <span class="pre">--version&quot;,</span> <span class="pre">my_calback]</span></code>.</p>
</dd>
<dt class="field-even">title</dt>
<dd class="field-even"><p>A title of a target. It will be printed when using <a class="reference internal" href="../core/index.html#piocore"><span class="std std-ref">PlatformIO Core (CLI)</span></a> or <a class="reference internal" href="../integration/ide/pioide.html#pioide"><span class="std std-ref">PlatformIO IDE</span></a>.
We recommend to keep a title very short, 1-2 words.</p>
</dd>
<dt class="field-odd">description</dt>
<dd class="field-odd"><p>The same as a <code class="docutils literal notranslate"><span class="pre">title</span></code> argument but allows you to provide detailed explanation
what target does.</p>
</dd>
<dt class="field-even">always_build</dt>
<dd class="field-even"><p>If there are declared <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and they are already built, this target
will not be called if <code class="docutils literal notranslate"><span class="pre">always_build=False</span></code>. A default value is
<code class="docutils literal notranslate"><span class="pre">always_build=True</span></code> and means always building/calling target.</p>
</dd>
</dl>
</div>
<div class="section" id="examples">
<h3><a class="toc-backref" href="#id8">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<div class="section" id="command-shortcut">
<h4><a class="toc-backref" href="#id9">Command shortcut</a><a class="headerlink" href="#command-shortcut" title="Permalink to this headline">¶</a></h4>
<p>Create a custom <code class="docutils literal notranslate"><span class="pre">node</span></code> target (alias) which will print a NodeJS version</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:myenv]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1"># Single action/command per 1 target</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddCustomTarget</span><span class="p">(</span><span class="s2">&quot;sysenv&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;python -c &quot;import os; print(os.environ)&quot;&#39;</span><span class="p">))</span>

<span class="c1"># Multiple actions</span>
<span class="n">env</span><span class="o">.</span><span class="n">AddCustomTarget</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pioenv&quot;</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;pio --version&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python --version&quot;</span>
    <span class="p">],</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Core Env&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Show PlatformIO Core and Python versions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now, run <code class="docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">--target</span> <span class="pre">sysenv</span></code> or <code class="docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">-t</span> <span class="pre">pioenv</span></code> (short version).</p>
</div>
<div class="section" id="dependent-target">
<h4><a class="toc-backref" href="#id10">Dependent target</a><a class="headerlink" href="#dependent-target" title="Permalink to this headline">¶</a></h4>
<p>Sometimes you need to run a command which depends on another target (file,
firmware, etc). Let’s create an <code class="docutils literal notranslate"><span class="pre">ota</span></code> target and declare command which will
depend on a project firmware. If a build process successes, declared command
will be run.</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:myenv]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">AddCustomTarget</span><span class="p">(</span>
    <span class="s2">&quot;ota&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$BUILD_DIR/$</span><span class="si">{PROGNAME}</span><span class="s2">.elf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ota_script --firmware-path $SOURCE&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now, run <code class="docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">-t</span> <span class="pre">ota</span></code>.</p>
</div>
<div class="section" id="target-with-options">
<h4><a class="toc-backref" href="#id11">Target with options</a><a class="headerlink" href="#target-with-options" title="Permalink to this headline">¶</a></h4>
<p>Let’s create a simple <code class="docutils literal notranslate"><span class="pre">ping</span></code> target and process it with
<code class="docutils literal notranslate"><span class="pre">pio</span> <span class="pre">run</span> <span class="pre">--target</span> <span class="pre">ping</span></code> command:</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:env_custom_target]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
<span class="na">custom_ping_host</span> <span class="o">=</span> <span class="s">google.com</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">GetProjectOption</span><span class="p">(</span><span class="s2">&quot;custom_ping_host&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mytarget_callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello PlatformIO!&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;ping &quot;</span> <span class="o">+</span> <span class="n">host</span><span class="p">)</span>


<span class="n">env</span><span class="o">.</span><span class="n">AddCustomTarget</span><span class="p">(</span><span class="s2">&quot;ping&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mytarget_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="other-use-cases">
<h2><a class="toc-backref" href="#id12">Other Use Cases</a><a class="headerlink" href="#other-use-cases" title="Permalink to this headline">¶</a></h2>
<p>The best examples are <a class="reference external" href="https://github.com/topics/platformio-platform">PlatformIO development platforms</a>.
Please check <code class="docutils literal notranslate"><span class="pre">builder</span></code> folder for the main and framework scripts.</p>
<div class="section" id="custom-options-in-platformio-ini">
<h3><a class="toc-backref" href="#id13">Custom options in <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code></a><a class="headerlink" href="#custom-options-in-platformio-ini" title="Permalink to this headline">¶</a></h3>
<p>PlatformIO allows you extending project configuration with own data. You can read
these values later using <a class="reference external" href="https://github.com/platformio/platformio-core/blob/develop/platformio/project/config.py">ProjectConfig API</a>:</p>
<dl class="field-list simple">
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">ProjectConfig::get(section,</span> <span class="pre">option,</span> <span class="pre">default=None)</span></code></dt>
<dd class="field-odd"><p>Get an option value for the named section</p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">ProjectConfig::options(section)</span></code></dt>
<dd class="field-even"><p>Returns a list of the sections available</p>
</dd>
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">ProjectConfig::items(section,</span> <span class="pre">as_dict=False)</span></code></dt>
<dd class="field-odd"><p>Returns a list of “name”, “value” pairs for the options in the given section or a dictionary when <code class="docutils literal notranslate"><span class="pre">as_dict=True</span></code> is passed</p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">ProjectConfig::has_section(section)</span></code></dt>
<dd class="field-even"><p>Indicates whether the named section is present in the configuration</p>
</dd>
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">ProjectConfig::has_option(section,</span> <span class="pre">option)</span></code></dt>
<dd class="field-odd"><p>If the given section exists, and contains the given option, returns <code class="docutils literal notranslate"><span class="pre">True</span></code>; otherwise returns <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd>
</dl>
<p>PlatformIO’s “ProjectConfig” is compatible with a native Python’s <a class="reference external" href="https://docs.python.org/3/library/configparser.html">ConfigParser</a> API.</p>
<p><strong>Example</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[universe]</span>
<span class="na">hello</span> <span class="o">=</span> <span class="s">world</span>

<span class="k">[env:my_env]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>

<span class="na">custom_option1</span> <span class="o">=</span> <span class="s">value1</span>
<span class="na">custom_option2</span> <span class="o">=</span> <span class="s">value2</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># &quot;env.GetProjectOption&quot; shortcut for the active environment</span>
<span class="n">value1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">GetProjectOption</span><span class="p">(</span><span class="s2">&quot;custom_option1&quot;</span><span class="p">)</span>
<span class="n">value2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">GetProjectOption</span><span class="p">(</span><span class="s2">&quot;custom_option2&quot;</span><span class="p">)</span>

<span class="c1"># Read value from other environments</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">GetProjectConfig</span><span class="p">()</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;universe&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="split-c-c-build-flags">
<h3><a class="toc-backref" href="#id14">Split C/C++ build flags</a><a class="headerlink" href="#split-c-c-build-flags" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:my_env]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> (place it near <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1"># General options that are passed to the C and C++ compilers</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CCFLAGS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flag1&quot;</span><span class="p">,</span> <span class="s2">&quot;flag2&quot;</span><span class="p">])</span>

<span class="c1"># General options that are passed to the C compiler (C only; not C++).</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CFLAGS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flag1&quot;</span><span class="p">,</span> <span class="s2">&quot;flag2&quot;</span><span class="p">])</span>

<span class="c1"># General options that are passed to the C++ compiler</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CXXFLAGS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flag1&quot;</span><span class="p">,</span> <span class="s2">&quot;flag2&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="extra-linker-flags-without-wl-prefix">
<h3><a class="toc-backref" href="#id15">Extra Linker Flags without <code class="docutils literal notranslate"><span class="pre">-Wl,</span></code> prefix</a><a class="headerlink" href="#extra-linker-flags-without-wl-prefix" title="Permalink to this headline">¶</a></h3>
<p>Sometimes you need to pass extra flags to GCC linker without <code class="docutils literal notranslate"><span class="pre">Wl,</span></code>. You could
use <a class="reference internal" href="section_env_build.html#projectconf-build-flags"><span class="std std-ref">build_flags</span></a> option but it will not work. PlatformIO
will not parse these flags to <code class="docutils literal notranslate"><span class="pre">LINKFLAGS</span></code> scope. In this case, simple
extra script will help:</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:env_extra_link_flags]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">windows_x86</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> (place it near <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Dump build environment (for debug)</span>
<span class="c1"># print(env.Dump())</span>
<span class="c1">#</span>

<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
  <span class="n">LINKFLAGS</span><span class="o">=</span><span class="p">[</span>
      <span class="s2">&quot;-static&quot;</span><span class="p">,</span>
      <span class="s2">&quot;-static-libgcc&quot;</span><span class="p">,</span>
      <span class="s2">&quot;-static-libstdc++&quot;</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-upload-tool">
<h3><a class="toc-backref" href="#id16">Custom upload tool</a><a class="headerlink" href="#custom-upload-tool" title="Permalink to this headline">¶</a></h3>
<p>You can override default upload command of development platform using extra
script. There is the common environment variable <code class="docutils literal notranslate"><span class="pre">UPLOADCMD</span></code> which PlatformIO
Build System will handle when you <a class="reference internal" href="../core/userguide/cmd_run.html#cmd-run"><span class="std std-ref">pio run -t upload</span></a>.</p>
<p>Please note that some development platforms can have more than 1 upload command.
For example, <a class="reference internal" href="../platforms/atmelavr.html#platform-atmelavr"><span class="std std-ref">Atmel AVR</span></a> has <code class="docutils literal notranslate"><span class="pre">UPLOADHEXCMD</span></code>
(firmware) and <code class="docutils literal notranslate"><span class="pre">UPLOADEEPCMD</span></code> (EEPROM data).</p>
<p>See examples below:</p>
<p><strong>Template</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:my_custom_upload_tool]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="c1">; place it into the root of project or use full path</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
<span class="na">upload_protocol</span> <span class="o">=</span> <span class="s">custom</span>
<span class="c1">; each flag in a new line</span>
<span class="na">upload_flags</span> <span class="o">=</span>
  <span class="na">-arg1</span>
  <span class="na">-arg2</span>
  <span class="na">-argN</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> (place it near <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1"># please keep $SOURCE variable, it will be replaced with a path to firmware</span>

<span class="c1"># Generic</span>
<span class="n">env</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span>
    <span class="n">UPLOADER</span><span class="o">=</span><span class="s2">&quot;executable or path to executable&quot;</span><span class="p">,</span>
    <span class="n">UPLOADCMD</span><span class="o">=</span><span class="s2">&quot;$UPLOADER $UPLOADERFLAGS $SOURCE&quot;</span>
<span class="p">)</span>

<span class="c1"># In-line command with arguments</span>
<span class="n">env</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span>
    <span class="n">UPLOADCMD</span><span class="o">=</span><span class="s2">&quot;executable -arg1 -arg2 $SOURCE&quot;</span>
<span class="p">)</span>

<span class="c1"># Python callback</span>
<span class="k">def</span> <span class="nf">on_upload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">firmware_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># do something</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;executable arg1 arg2&quot;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">UPLOADCMD</span><span class="o">=</span><span class="n">on_upload</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Custom openOCD command</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:disco_f407vg]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">ststm32</span>
<span class="na">board</span> <span class="o">=</span> <span class="s">disco_f407vg</span>
<span class="na">framework</span> <span class="o">=</span> <span class="s">mbed</span>

<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
<span class="na">upload_protocol</span> <span class="o">=</span> <span class="s">custom</span>
<span class="c1">; each flag in a new line</span>
<span class="na">upload_flags</span> <span class="o">=</span>
    <span class="na">-f</span>
    <span class="na">scripts/interface/stlink.cfg</span>
    <span class="na">-f</span>
    <span class="na">scripts/target/stm32f4x.cfg</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> (place it near <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">platform</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">PioPlatform</span><span class="p">()</span>

<span class="n">env</span><span class="o">.</span><span class="n">Prepend</span><span class="p">(</span>
    <span class="n">UPLOADERFLAGS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_package_dir</span><span class="p">(</span><span class="s2">&quot;tool-openocd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
    <span class="n">UPLOADERFLAGS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;program {{$SOURCE}} verify reset; shutdown&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span>
    <span class="n">UPLOADER</span><span class="o">=</span><span class="s2">&quot;openocd&quot;</span><span class="p">,</span>
    <span class="n">UPLOADCMD</span><span class="o">=</span><span class="s2">&quot;$UPLOADER $UPLOADERFLAGS&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="upload-to-cloud-ota">
<h3><a class="toc-backref" href="#id17">Upload to Cloud (OTA)</a><a class="headerlink" href="#upload-to-cloud-ota" title="Permalink to this headline">¶</a></h3>
<p>See project example <a class="reference external" href="https://github.com/platformio/bintray-secure-ota">https://github.com/platformio/bintray-secure-ota</a></p>
</div>
<div class="section" id="custom-firmware-program-name">
<h3><a class="toc-backref" href="#id18">Custom firmware/program name</a><a class="headerlink" href="#custom-firmware-program-name" title="Permalink to this headline">¶</a></h3>
<p>Sometimes is useful to have a different firmware/program name in
<a class="reference internal" href="section_platformio.html#projectconf-pio-build-dir"><span class="std std-ref">build_dir</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:env_custom_prog_name]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">espressif8266</span>
<span class="na">board</span> <span class="o">=</span> <span class="s">nodemcuv2</span>
<span class="na">framework</span> <span class="o">=</span> <span class="s">arduino</span>
<span class="na">build_flags</span> <span class="o">=</span> <span class="s">-D VERSION=13</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">pre:extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">my_flags</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ParseFlags</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;BUILD_FLAGS&#39;</span><span class="p">])</span>
<span class="n">defines</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">my_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CPPDEFINES&quot;</span><span class="p">)}</span>
<span class="c1"># print(defines)</span>

<span class="n">env</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">PROGNAME</span><span class="o">=</span><span class="s2">&quot;firmware_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">defines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VERSION&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="override-package-files">
<h3><a class="toc-backref" href="#id19">Override package files</a><a class="headerlink" href="#override-package-files" title="Permalink to this headline">¶</a></h3>
<p>PlatformIO Package Manager automatically installs pre-built packages
(<a class="reference internal" href="../frameworks/index.html#frameworks"><span class="std std-ref">Frameworks</span></a>, toolchains, libraries) required by development
<a class="reference internal" href="../platforms/index.html#platforms"><span class="std std-ref">Development Platforms</span></a> and build process. Sometimes you need to override original
files with own versions: configure custom GPIO, do changes to built-in LD
scripts, or some patching to installed library dependency.</p>
<p>The simplest way is using <a class="reference external" href="https://linuxacademy.com/blog/linux/introduction-using-diff-and-patch/">Diff and Patch technique</a>. How does it work?</p>
<ol class="arabic simple">
<li><p>Modify original source files</p></li>
<li><p>Generate patches</p></li>
<li><p>Apply patches via PlatformIO extra script before build process.</p></li>
</ol>
<p><strong>Example</strong></p>
<p>We need to patch the original <code class="docutils literal notranslate"><span class="pre">standard/pins_arduino.h</span></code> variant from
<a class="reference internal" href="../frameworks/arduino.html#framework-arduino"><span class="std std-ref">Arduino</span></a> framework and add extra macro <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">PIN_A8</span>&#160;&#160; <span class="pre">(99)</span></code>.
Let’s duplicate <code class="docutils literal notranslate"><span class="pre">standard/pins_arduino.h</span></code> and apply changes. Generate a
patch file and place it into <code class="docutils literal notranslate"><span class="pre">patches</span></code> folder located in the root of a project:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>diff ~/.platformio/packages/framework-arduinoavr/variants/standard/pins_arduino.h /tmp/pins_arduino_modified.h &gt; /path/to/platformio/project/patches/1-framework-arduinoavr-add-pin-a8.patch
</pre></div>
</div>
<p>The result of <code class="docutils literal notranslate"><span class="pre">1-framework-arduinoavr-add-pin-a8.patch</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span>63a64
&gt; #define PIN_A8   (99)
112c113
&lt; // 14-21 PA0-PA7 works
<span class="gd">---</span>
&gt; // 14-21 PA0-PA7 works
</pre></div>
</div>
<p>Using extra scripting we can apply patching before a build process. The final
result of <a class="reference internal" href="index.html#projectconf"><span class="std std-ref">“platformio.ini” (Project Configuration File)</span></a> and “PRE” extra script named <code class="docutils literal notranslate"><span class="pre">apply_patches.py</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:uno]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">atmelavr</span>
<span class="na">board</span> <span class="o">=</span> <span class="s">uno</span>
<span class="na">framework</span> <span class="o">=</span> <span class="s">arduino</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">pre:apply_patches.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">apply_patches.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span>

<span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">FRAMEWORK_DIR</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">PioPlatform</span><span class="p">()</span><span class="o">.</span><span class="n">get_package_dir</span><span class="p">(</span><span class="s2">&quot;framework-arduinoavr&quot;</span><span class="p">)</span>
<span class="n">patchflag_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">FRAMEWORK_DIR</span><span class="p">,</span> <span class="s2">&quot;.patching-done&quot;</span><span class="p">)</span>

<span class="c1"># patch file only if we didn&#39;t do it before</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">FRAMEWORK_DIR</span><span class="p">,</span> <span class="s2">&quot;.patching-done&quot;</span><span class="p">)):</span>
    <span class="n">original_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">FRAMEWORK_DIR</span><span class="p">,</span> <span class="s2">&quot;variants&quot;</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="s2">&quot;pins_arduino.h&quot;</span><span class="p">)</span>
    <span class="n">patched_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;patches&quot;</span><span class="p">,</span> <span class="s2">&quot;1-framework-arduinoavr-add-pin-a8.patch&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">isfile</span><span class="p">(</span><span class="n">original_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isfile</span><span class="p">(</span><span class="n">patched_file</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;patch </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">original_file</span><span class="p">,</span> <span class="n">patched_file</span><span class="p">))</span>
    <span class="c1"># env.Execute(&quot;touch &quot; + patchflag_path)</span>


    <span class="k">def</span> <span class="nf">_touch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_touch</span><span class="p">(</span><span class="n">patchflag_path</span><span class="p">))</span>
</pre></div>
</div>
<p>Please note that this example will work on a system where a <code class="docutils literal notranslate"><span class="pre">patch</span></code> tool
is available. For Windows OS, you can use <code class="docutils literal notranslate"><span class="pre">patch</span></code> and <code class="docutils literal notranslate"><span class="pre">diff</span></code> tools
provided by <a class="reference external" href="https://git-scm.com/">Git client utility</a>
(located inside installation directory).</p>
<p>If you need to make it more independent to the operating system,
please replace the <code class="docutils literal notranslate"><span class="pre">patch</span></code> with a multi-platform
<a class="reference external" href="https://github.com/techtonik/python-patch">python-patch</a> script.</p>
</div>
<div class="section" id="override-board-configuration">
<h3><a class="toc-backref" href="#id20">Override Board Configuration</a><a class="headerlink" href="#override-board-configuration" title="Permalink to this headline">¶</a></h3>
<p>PlatformIO allows one to override some basic options (integer or string values)
using <a class="reference internal" href="section_env_platform.html#projectconf-board-more-options"><span class="std std-ref">More options</span></a> in <a class="reference internal" href="index.html#projectconf"><span class="std std-ref">“platformio.ini” (Project Configuration File)</span></a>.
Sometimes you need to do complex changes to default board manifest and
extra PRE scripting work well here. See example below how to override default
hardware VID/PIDs.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Due to a technical limitation these board changes will not work for
<a class="reference internal" href="../core/userguide/device/cmd_monitor.html#cmd-device-monitor"><span class="std std-ref">pio device monitor</span></a> command.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:uno]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">atmelavr</span>
<span class="na">board</span> <span class="o">=</span> <span class="s">uno</span>
<span class="na">framework</span> <span class="o">=</span> <span class="s">arduino</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">pre:custon_hwids.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">custon_hwids.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="n">board_config</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">BoardConfig</span><span class="p">()</span>
<span class="c1"># should be array of VID:PID pairs</span>
<span class="n">board_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;build.hwids&quot;</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">[</span><span class="s2">&quot;0x2341&quot;</span><span class="p">,</span> <span class="s2">&quot;0x0243&quot;</span><span class="p">],</span>  <span class="c1"># 1st pair</span>
  <span class="p">[</span><span class="s2">&quot;0x2A03&quot;</span><span class="p">,</span> <span class="s2">&quot;0x0043&quot;</span><span class="p">]</span><span class="o">.</span>  <span class="c1"># 2nd pair, etc.</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-debug-flags">
<h3><a class="toc-backref" href="#id21">Custom debug flags</a><a class="headerlink" href="#custom-debug-flags" title="Permalink to this headline">¶</a></h3>
<p>PlatformIO removes all debug/optimization flags before a debug session or when
<a class="reference internal" href="build_configurations.html#build-configurations"><span class="std std-ref">Build Configurations</span></a> is set to <code class="docutils literal notranslate"><span class="pre">debug</span></code> and overrides them with
<code class="docutils literal notranslate"><span class="pre">-0g</span> <span class="pre">-g2</span> <span class="pre">-ggdb2</span></code> for <code class="docutils literal notranslate"><span class="pre">ASFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CCFLAGS</span></code>, and <code class="docutils literal notranslate"><span class="pre">LINKFLAGS</span></code> build
scopes.</p>
<p>An extra script allows us to override PlatformIO’s default behavior and declare
custom flags. See example below where we override <code class="docutils literal notranslate"><span class="pre">-Og</span></code> with <code class="docutils literal notranslate"><span class="pre">-O0</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:teensy31]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">teensy</span>
<span class="na">board</span> <span class="o">=</span> <span class="s">teensy31</span>
<span class="na">framework</span> <span class="o">=</span> <span class="s">arduino</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">custom_debug_flags.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">custom_debug_flags.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">GetBuildType</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
   <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ASFLAGS&quot;</span><span class="p">,</span> <span class="s2">&quot;CCFLAGS&quot;</span><span class="p">,</span> <span class="s2">&quot;LINKFLAGS&quot;</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">scope</span><span class="p">]):</span>
         <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;-Og&quot;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="n">scope</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-O0&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="extra-python-packages">
<h3><a class="toc-backref" href="#id22">Extra Python packages</a><a class="headerlink" href="#extra-python-packages" title="Permalink to this headline">¶</a></h3>
<p>If your project depends on the extra Python packages, you can use extra script to
install them into the same virtual environment where <a class="reference internal" href="../core/index.html#piocore"><span class="std std-ref">PlatformIO Core (CLI)</span></a> is installed.</p>
<p><code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[env:my_env]</span>
<span class="na">platform</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">extra_scripts</span> <span class="o">=</span> <span class="s">extra_script.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">extra_script.py</span></code> (place it near <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>

<span class="c1"># List installed packages</span>
<span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;$PYTHONEXE -m pip list&quot;</span><span class="p">)</span>

<span class="c1"># Install custom packages from the PyPi registry</span>
<span class="n">env</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="s2">&quot;$PYTHONEXE -m pip install pkg1 pkg2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../librarymanager/index.html" class="btn btn-neutral float-right" title="Library Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../envvars.html" class="btn btn-neutral float-left" title="Environment variables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2014-present, PlatformIO.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1768265-7', 'auto');
    
    ga('send', 'pageview');
    </script>

    
  


<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Documentation</span>
    v5.1.1 (stable)
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      
        <dd><a href="/en/">latest</a></dd>
      
        <dd><a href="/en/stable/">stable</a></dd>
      
    </dl>
    <dl>
      <dt>On Github</dt>
        <dd><a href="https://github.com/platformio/platformio-docs/blob/develop/projectconf/advanced_scripting.rst"> View</a></dd>
        <dd><a href="https://github.com/platformio/platformio-docs/edit/develop/projectconf/advanced_scripting.rst"> Edit</a></dd>
    </dl>
    <dl>
      <dt>Search</dt>
        <dd>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div></dd>
    </dl>
  </div>
</div>
 
<script>
  var navBarHTML = '\
<div>\
  <div class="container container-fluid">\
    <div class="navbar-header">\
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navBarCollapse" aria-expanded="false">\
        <span class="sr-only">Toggle navigation</span>\
        <span class="icon-bar"></span>\
        <span class="icon-bar"></span>\
        <span class="icon-bar"></span>\
      </button>\
      <a class="navbar-brand" href="https://platformio.org" title="PlatformIO"></a>\
    </div>\
    <nav role="navigation" class="collapse navbar-collapse" id="navBarCollapse">\
      <div>\
        <ul class="nav navbar-nav">\
          <li class="dropdown">\
            <a role="button" data-target="#" href="https://platformio.org/platformio-ide" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-rocket fa-lg"></i>Get Started<span class="caret"></span>\
            </a>\
            <ul class="dropdown-menu" role="menu">\
              <li role="menuitem"><a href="https://docs.platformio.org/page/what-is-platformio.html"><i class="fa fa-heart"></i>What is PlatformIO?</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://platformio.org/platformio-ide"><i class="fa fa-cube"></i>PlatformIO IDE</a></li>\
              <li role="menuitem"><a href="https://platformio.org/install/cli"><i class="fa fa-cogs"></i>PlatformIO Core (CLI)</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/librarymanager/index.html"><i class="fa fa-code"></i>Library Management</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/tutorials/index.html" target="_blank"><i class="fa fa-graduation-cap"></i>Tutorials</a></li>\
              <li role="menuitem"><a href="https://github.com/platformio/platformio-examples" target="_blank"><i class="fa fa-graduation-cap"></i>Project Examples</a></li>\
            </ul>\
          </li>\
          <li class="dropdown">\
            <a role="button" data-target="#" href="https://docs.platformio.org/page/plus/pio-remote.html" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-lightbulb-o fa-lg"></i>\
              Solutions<span class="caret"></span>\
            </a>\
            <ul class="dropdown-menu" role="menu">\
              <li role="menuitem"><a href="https://platformio.org/platformio-ide"><i class="fa fa-cube"></i>PlatformIO IDE</a></li>\
              <li role="menuitem"><a href="https://platformio.org/install/cli"><i class="fa fa-cogs"></i>PlatformIO Core (CLI)</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/plus/debugging.html"><i class="fa fa-bug"></i>Debugging</a></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/plus/unit-testing.html"><i class="fa fa-puzzle-piece"></i>Unit Testing</a></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/plus/pio-check.html"><i class="fa fa-check-circle-o"></i>Static Code Analysis</a></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/plus/pio-remote.html"><i class="fa fa-globe"></i>Remote Development</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/librarymanager/index.html"><i class="fa fa-code"></i>Library Management</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://platformio.org/install/integration"><i class="fa fa-cube"></i>Desktop IDEs Integration</a></li>\
              <li role="menuitem"><a href="https://platformio.org/install/integration"><i class="fa fa-cloud"></i>Cloud IDEs Integration</a></li>\
              <li role="menuitem"><a href="https://docs.platformio.org/page/ci/index.html"><i class="fa fa-refresh"></i>Continuous Integration</a></li>\
            </ul>\
          </li>\
          <li class="dropdown">\
            <a role="button" data-target="#" href="https://platformio.org/lib" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-code fa-lg"></i>Registry<span class="caret"></span>\
            </a>\
            <ul class="dropdown-menu" role="menu">\
              <li role="menuitem"><a href="https://platformio.org/lib"><i class="fa fa-code"></i>Libraries</a></li>\
              <li role="separator" class="divider"></li>\
              <li role="menuitem"><a href="https://platformio.org/platforms"><i class="fa fa-laptop"></i>Platforms</a></li>\
              <li role="menuitem"><a href="https://platformio.org/frameworks"><i class="fa fa-cog"></i>Frameworks</a></li>\
              <li role="menuitem"><a href="https://platformio.org/boards"><i class="fa fa-microchip"></i>Boards</a></li>\
            </ul>\
          </li>\
        </ul>\
        <ul class="nav navbar-nav navbar-right">\
          <li class="active"><a href="https://docs.platformio.org"><i class="fa fa-book fa-lg"></i>Docs</a></li>\
          <li><a href="https://community.platformio.org/"><i class="fa fa-comments-o fa-lg"></i>Community</a></li>\
          <li><a href="https://platformio.org/support"><i class="fa fa-question-circle fa-lg"></i>Support</a></li>\
          <li class="nav-pio-tech"><a href="https://piolabs.com/"><i class="fa fa-heart-o fa-lg"></i>TECHNOLOGY</a></li>\
        </ul>\
      </div>\
    </nav>\
  </div>\
</div>';

  (function() {
    if (window.location.href.indexOf('http://') === 0) {
      location.href = 'https:' + window.location.href.substring(5);
    }

    var topBanner = $('.top-banner');
    var navBar = document.createElement('header');
    navBar.className = 'navbar navbar-inverse';
    navBar.innerHTML = navBarHTML;
    if (topBanner.length) {
      $(navBar).insertAfter(topBanner)
    } else {
      document.body.insertBefore(navBar, document.body.firstChild);
    }

    if ($(window).width() <= 768) {
      return;
    }

    var topOffset = 50;
    if (topBanner.length) {
      topOffset += $('.navbar').offset().top;
    }
    $('.wy-nav-side').css('top', topOffset + 'px');
    $(window).scroll(function() {
      $('.wy-nav-side').css('top', $(window).scrollTop() > topOffset ? 0 : topOffset + 'px');
    });
  })();
</script>


</body>
</html>